<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>quantdigger.plugin.mplotwidgets.stock_plot &mdash; quantdigger 0.1 文档</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="quantdigger 0.1 文档" href="../../../../index.html" />
    <link rel="up" title="模块代码" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python 模块索引"
             >模块</a> |</li>
        <li><a href="../../../../index.html">quantdigger 0.1 文档</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">模块代码</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>quantdigger.plugin.mplotwidgets.stock_plot 源代码</h1><div class="highlight"><pre>
<span class="c"># -*- coding: gbk -*-</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&quot;TKAgg&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">Cursor</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">MultiCursor</span>
<span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="kn">import</span> <span class="n">FontProperties</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c">#from pylab import *  </span>
<span class="c">#mpl.rcParams[&#39;font.sans-serif&#39;] =  [&#39;Microsoft YaHei&#39;] #指定默认字体  </span>

<div class="viewcode-block" id="accumulate"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.accumulate">[文档]</a><span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">):</span>
    <span class="s">&#39;Return running totals&#39;</span>
    <span class="c"># accumulate([1,2,3,4,5]) --&gt; 1 3 6 10 15</span>
    <span class="c"># accumulate([1,2,3,4,5], operator.mul) --&gt; 1 2 6 24 120</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="c">#rst = []</span>
    <span class="k">yield</span> <span class="n">total</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">total</span>
</div>
<span class="n">font</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> 
<span class="n">font_big</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span> 


<div class="viewcode-block" id="EventHandler"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.EventHandler">[文档]</a><span class="k">class</span> <span class="nc">EventHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;docstring for EventHandler&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_x</span> <span class="o">=</span> <span class="bp">None</span>
    
<div class="viewcode-block" id="EventHandler.on_pick"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.EventHandler.on_pick">[文档]</a>    <span class="k">def</span> <span class="nf">on_pick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;docstring for on_motion&#39;&#39;&#39;</span> 
        <span class="k">print</span> <span class="s">&quot;888888&quot;</span> 
        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span>
        <span class="c">#print event.artist</span>
</div>
<div class="viewcode-block" id="EventHandler.on_move"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.EventHandler.on_move">[文档]</a>    <span class="k">def</span> <span class="nf">on_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;docstring for on_motion&#39;&#39;&#39;</span> 
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_x</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;hh&quot;</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pre_x</span> <span class="o">=</span> <span class="n">i</span>

</div></div>
<div class="viewcode-block" id="plot_simple_entry"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_simple_entry">[文档]</a><span class="k">def</span> <span class="nf">plot_simple_entry</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">entry_nbar_best</span><span class="p">,</span> <span class="n">entry_nbar_worst</span><span class="p">,</span> <span class="n">nbar</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;docstring for plot_simple_entry&#39;&#39;&#39;</span> 
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;入场信息&#39;</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">entry_nbar_best</span> <span class="o">=</span> <span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
    <span class="n">entry_nbar_worst</span> <span class="o">=</span> <span class="n">entry_nbar_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最优&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="c">#ax1.bar(range(len(entry_nbar_best)), entry_nbar_best, color=&#39;r&#39;, label=u&quot;%s根最优&quot;%nbar)</span>
        <span class="n">entry_nbar_worst</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最差&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">),</span> <span class="s">&#39;y--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;平均风险: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">),</span> 
                    <span class="s">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;平均最优: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">],</span> <span class="p">[]</span>

</div>
<div class="viewcode-block" id="plot_entry"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_entry">[文档]</a><span class="k">def</span> <span class="nf">plot_entry</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">,</span> <span class="n">entry_worst</span><span class="p">,</span> <span class="n">entry_nbar_best</span><span class="p">,</span> <span class="n">entry_nbar_worst</span><span class="p">,</span> <span class="n">nbar</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;入场信息&#39;</span><span class="p">)</span>
    <span class="n">axescolor</span>  <span class="o">=</span> <span class="s">&#39;#f6f6f6&#39;</span>  <span class="c"># the axes background color</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span>
    <span class="n">rect1</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span><span class="c">#left, bottom, width, height</span>
    <span class="n">rect2</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
    <span class="n">rect3</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>

    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect1</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axescolor</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect2</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axescolor</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">)</span>
    <span class="n">ax3</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect3</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axescolor</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">entry_best</span><span class="o">-</span><span class="n">exit_profit</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;优实差&quot;</span><span class="p">)</span>
    <span class="n">entry_worst</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;最大不利偏移&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbar</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最优&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="c">#ax3.bar(range(len(entry_nbar_best)), entry_nbar_best, color=&#39;r&#39;, label=u&quot;%s根最优&quot;%nbar)</span>
        <span class="n">entry_nbar_worst</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最差&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">),</span> <span class="s">&#39;y--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;平均风险: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">),</span> 
                    <span class="s">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;平均最优: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">)):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> 
            <span class="n">px21</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">px22</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="n">px21</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px22</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s">u&#39;实际盈利&#39;</span><span class="p">,</span> <span class="s">u&#39;早出最优盈利&#39;</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;交易区间内的差值&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;交易区间内的盈利&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">:</span>
        <span class="c">#if ax!=ax3:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">u&quot;入场相关信息&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiCursor</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">horizOn</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vertOn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#handle = EventHandler(exit_profit, fig)</span>
    <span class="c">#fig.canvas.mpl_connect(&#39;motion_notify_event&#39;, handle.on_move)</span>
    <span class="c">#fig.canvas.mpl_connect(&#39;pick_event&#39;, handle.on_pick)</span>

    <span class="k">def</span> <span class="nf">format_coord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 状态栏信息显示 &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; Profit: </span><span class="si">%s</span><span class="s"> MAE: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">entry_worst</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">],</span> <span class="p">[</span><span class="n">multi</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="plot_exit"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_exit">[文档]</a><span class="k">def</span> <span class="nf">plot_exit</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">,</span> <span class="n">exit_nbar_worst</span><span class="p">,</span> <span class="n">profits_more</span><span class="p">,</span> <span class="n">risks</span><span class="p">,</span> <span class="n">nbar</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c">#fig.canvas.set_window_title(u&#39;出场信息&#39;)</span>
    <span class="n">axescolor</span>  <span class="o">=</span> <span class="s">&#39;#f6f6f6&#39;</span>  <span class="c"># the axes background color</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span>
    <span class="n">rect2</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>
    <span class="n">rect3</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>

    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect3</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axescolor</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect2</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axescolor</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;**66666&quot;</span> 
        <span class="c"># plot ax1</span>
        <span class="n">profits_more</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最优&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="n">risks</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最差&quot;</span><span class="o">%</span><span class="n">nbar</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">risks</span><span class="p">[</span><span class="n">risks</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s">&#39;y--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;平均风险: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">profits_more</span><span class="p">[</span><span class="n">profits_more</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span> <span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;平均更优: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c">#ax1.annotate(str(np.mean(risks)), xy=(len(records)/2, np.mean(risks)),  xycoords=&#39;data&#39;,</span>
                        <span class="c">#xytext=(-30, -30), textcoords=&#39;offset points&#39;, color=&#39;b&#39;,</span>
                        <span class="c">#arrowprops=dict(arrowstyle=&quot;-&gt;&quot;,</span>
                                        <span class="c">#connectionstyle=&quot;arc3,rad=.2&quot;)</span>
                        <span class="c">#)</span>

        <span class="c"># plot ax2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">)):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">px21</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
                <span class="n">px22</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_nbar_best</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">binwidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="n">px21</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px22</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s">u&#39;实际盈利&#39;</span><span class="p">,</span> <span class="s">u&#39;延出最优盈利&#39;</span><span class="p">),</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span>  <span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;交易区间内的盈利&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">:</span>
            <span class="c">#if ax!=ax1:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">u&quot;出场相关信息&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiCursor</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">horizOn</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vertOn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">multi</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

</div>
<div class="viewcode-block" id="plot_summary"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_summary">[文档]</a><span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">,</span> <span class="n">entry_worst</span><span class="p">,</span> <span class="n">entry_nbar_best</span><span class="p">,</span> <span class="n">entry_nbar_worst</span><span class="p">,</span> 
                    <span class="n">exit_nbar_best</span><span class="p">,</span> <span class="n">exit_nbar_worst</span><span class="p">,</span> <span class="n">profits_more</span><span class="p">,</span> <span class="n">risks</span><span class="p">,</span> <span class="n">NBAR</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;画图汇总&#39;</span><span class="p">)</span>
    <span class="n">ax11</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax12</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax21</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax22</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax31</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax32</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="c">#plt.subplots_adjust(left=0, right=1)</span>

    <span class="c"># Profits Distribution</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shift</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax11</span><span class="p">,</span>  <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;盈利&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;亏损&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">entry_worst</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;最差偏移&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


    <span class="c"># Profits Distribution Bins</span>
    <span class="c">#exit_profit.hist(ax=ax12, bins=50, normed=True, color=&#39;r&#39;)</span>
    <span class="c">#n, bins = np.histogram(exit_profit.tolist(), 50, normed=True)</span>
    <span class="c">#ax12.plot([0, 0], [0, max(n)], color=&#39;y&#39;, linewidth=2)</span>
    <span class="c">#ax12.grid(False)</span>
    <span class="n">exit_profit</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax12</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;kde&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">binwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">exit_profit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;盈利分布&#39;</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;亏损分布&#39;</span><span class="p">)</span>
    <span class="n">plot_contribution</span><span class="p">(</span><span class="n">ax12</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">,</span> <span class="s">&#39;bo--&#39;</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c">#ax12.set_yscale(&#39;log&#39;)</span>

    <span class="c"># MAE</span>
    <span class="n">MAE</span> <span class="o">=</span> <span class="n">entry_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">MAE</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax21</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;最大不利偏移&#39;</span><span class="p">)</span>
    <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax21</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;亏损分布&#39;</span><span class="p">)</span>
    <span class="n">worst</span> <span class="o">=</span> <span class="n">MAE</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">u&quot;最大不利偏移: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">worst</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="n">worst</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])),</span> <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">bb</span><span class="o">&lt;</span><span class="n">aa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MAE</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c"># Potential Profits When Lose</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;最优盈利&quot;</span> <span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span> <span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;有序最优盈利&quot;</span> <span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;实际亏损&#39;</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MAE</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">NBAR</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># Entry N Bar</span>
        <span class="n">enbest</span> <span class="o">=</span> <span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
        <span class="n">enbest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax31</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最优平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">enworst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">entry_nbar_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">enworst</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax31</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最差平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c"># Exit N Bar</span>
        <span class="n">profits_more</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">profits_more</span><span class="p">[</span><span class="n">profits_more</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax32</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span>
                <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最优平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">profits_more</span><span class="p">[</span><span class="n">profits_more</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">risks</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">risks</span><span class="p">[</span><span class="n">risks</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax32</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span>
                <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">根最差平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">NBAR</span><span class="p">,</span><span class="n">risks</span><span class="p">[</span><span class="n">risks</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">ax32</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c">#ax31.xaxis_date()</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([]),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;盈利分布&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;盈利统计&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;最大不利偏移和亏损&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;亏损交易的潜在盈利空间&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax31</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;进场后</span><span class="si">%s</span><span class="s">根&quot;</span><span class="o">%</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax32</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;离场后</span><span class="si">%s</span><span class="s">根&quot;</span><span class="o">%</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>

    <span class="n">cursors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">]:</span>
        <span class="n">cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cursor</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                            <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">],</span> <span class="n">cursors</span>

</div>
<div class="viewcode-block" id="plot_scatter"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_scatter">[文档]</a><span class="k">def</span> <span class="nf">plot_scatter</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">binnum</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;docstring for plot_test&#39;&#39;&#39;</span> 
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;交易鸟瞰图&#39;</span><span class="p">)</span>
    <span class="c"># definitions for the axes </span>
    <span class="n">left</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.65</span>
    <span class="n">bottom</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.65</span>
    <span class="n">bottom_h</span> <span class="o">=</span> <span class="n">left_h</span> <span class="o">=</span> <span class="n">left</span><span class="o">+</span><span class="n">width</span><span class="o">+</span><span class="mf">0.02</span>

    <span class="n">rect_scatter</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">]</span>
    <span class="n">rect_histx</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom_h</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
    <span class="n">rect_histy</span> <span class="o">=</span> <span class="p">[</span><span class="n">left_h</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">height</span><span class="p">]</span>

    <span class="c"># start with a rectangular Figure</span>

    <span class="n">axScatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">rect_scatter</span><span class="p">)</span>
    <span class="n">axHistx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">rect_histx</span><span class="p">)</span>
    <span class="n">axHisty</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">rect_histy</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">(</span><span class="n">axScatter</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>

    <span class="n">axScatter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">axScatter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">)</span>

    <span class="c"># now determine nice limits by hand:</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">binwidth</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">/</span> <span class="n">binnum</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">xmax</span><span class="o">/</span><span class="n">binwidth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span> <span class="o">+</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span>
    <span class="n">binwidth</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">/</span><span class="n">binnum</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymax</span><span class="o">/</span><span class="n">binwidth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span> <span class="o">+</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span> <span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span> <span class="p">)</span>

    <span class="n">xymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">y2</span><span class="p">))]</span> <span class="p">)</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">xymax</span><span class="o">/</span><span class="n">binwidth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span>
    <span class="n">axScatter</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

    <span class="c">#axScatter.set_xlim( (-xmin-10, xmax+10))</span>
    <span class="c">#axScatter.set_ylim((-ymin-10, ymax+10))</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span> <span class="n">axScatter</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">axScatter</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;盈亏分布&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font_big</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;周期分布&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font_big</span><span class="p">)</span>
    <span class="n">axScatter</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;盈亏和周期分布&quot;</span><span class="p">,</span> <span class="n">fontproperties</span> <span class="o">=</span> <span class="n">font_big</span><span class="p">)</span>

    <span class="n">axScatter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">(</span><span class="n">axScatter</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">axScatter</span><span class="p">,</span> <span class="n">axHistx</span><span class="p">,</span> <span class="n">axHisty</span><span class="p">],</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="plot_compare"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_compare">[文档]</a><span class="k">def</span> <span class="nf">plot_compare</span><span class="p">(</span><span class="n">exit_profits</span><span class="p">,</span> <span class="n">entry_bests</span><span class="p">,</span> <span class="n">entry_worsts</span><span class="p">,</span> <span class="n">entry_nbar_bests</span><span class="p">,</span> <span class="n">entry_nbar_worsts</span><span class="p">,</span> 
                    <span class="n">exit_nbar_bests</span><span class="p">,</span> <span class="n">exit_nbar_worsts</span><span class="p">,</span> <span class="n">profits_mores</span><span class="p">,</span> <span class="n">risks</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">NBAR</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;画图汇总一&#39;</span><span class="p">)</span>
    <span class="n">ax11</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax12</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax21</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax22</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax31</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax32</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="c">#plt.subplots_adjust(left=0, right=1)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profits</span><span class="p">)):</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">exit_profit</span> <span class="o">=</span> <span class="n">exit_profits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_best</span> <span class="o">=</span> <span class="n">entry_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_worst</span> <span class="o">=</span> <span class="n">entry_worsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_nbar_best</span> <span class="o">=</span> <span class="n">entry_nbar_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_nbar_worst</span> <span class="o">=</span> <span class="n">entry_nbar_worsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">exit_nbar_best</span> <span class="o">=</span> <span class="n">exit_nbar_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">exit_nbar_worst</span> <span class="o">=</span> <span class="n">exit_nbar_worsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">profits_more</span> <span class="o">=</span> <span class="n">profits_mores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">risks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c"># Profits Distribution</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shift</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax11</span><span class="p">,</span>  <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">盈利&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">亏损&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">entry_worst</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">最差偏移&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="c">#ax11.set_xscale(&#39;log&#39;)</span>


        <span class="c"># Profits Distribution Bins</span>
        <span class="c">#exit_profit.hist(ax=ax12, bins=50, normed=True, color=c)</span>
        <span class="c">#exit_profit.plot(ax=ax12, kind=&#39;kde&#39;, color=&#39;b&#39;, label=&quot;&quot;)</span>
        <span class="c">#ax12.legend(prop=font, loc=&#39;upper left&#39;).get_frame().set_alpha(0.5)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">bins</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax12</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">n</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">盈利分布&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">bins</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax12</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">n</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">亏损分布&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">ax12</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        

        <span class="c"># MAE</span>
        <span class="n">MAE</span> <span class="o">=</span> <span class="n">entry_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">MAE</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax21</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">最大不利偏移&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax21</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">亏损分布&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>

        <span class="c"># Potential Profits When Lose</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">entry_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">最优盈利&quot;</span> <span class="o">%</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">有序最优盈利&quot;</span> <span class="o">%</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">ax22</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">exit_profit</span><span class="p">[</span><span class="n">exit_profit</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">实际亏损&#39;</span><span class="o">%</span><span class="n">nm</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c"># Entry N Bar</span>
            <span class="n">entry_nbar_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax31</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s%s</span><span class="s">根最优平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">NBAR</span><span class="p">,</span> <span class="n">entry_nbar_best</span><span class="p">[</span><span class="n">entry_nbar_best</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
            <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">entry_nbar_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax31</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s%s</span><span class="s">根最差平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">NBAR</span><span class="p">,</span> <span class="n">entry_nbar_worst</span><span class="p">[</span><span class="n">entry_nbar_worst</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>

            <span class="c"># Exit N Bar</span>
            <span class="n">profits_more</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">profits_more</span><span class="p">[</span><span class="n">profits_more</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax32</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s%s</span><span class="s">根最优平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">profits_more</span><span class="p">[</span><span class="n">profits_more</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
            <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">risk</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">risk</span><span class="p">[</span><span class="n">risk</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax32</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">--&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s%s</span><span class="s">根最差平均: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="n">NBAR</span><span class="p">,</span><span class="n">risk</span><span class="p">[</span><span class="n">risk</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>

    <span class="c">#</span>
    <span class="c">#ax31.xaxis_date()</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([]),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">])</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;盈利分布&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&quot;盈利统计&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;最大不利偏移和亏损&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;亏损交易的潜在盈利空间&quot;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax31</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;进场后</span><span class="si">%s</span><span class="s">根&quot;</span><span class="o">%</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax32</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&quot;离场后</span><span class="si">%s</span><span class="s">根&quot;</span><span class="o">%</span><span class="n">NBAR</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax31</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax31</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax32</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">ax21</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MAE</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ax22</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">exit_profit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MAE</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">cursors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">]:</span>
        <span class="n">cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cursor</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                            <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">cursors</span>

</div>
<div class="viewcode-block" id="ax_normed_data"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.ax_normed_data">[文档]</a><span class="k">def</span> <span class="nf">ax_normed_data</span><span class="p">(</span><span class="n">x1list</span><span class="p">,</span> <span class="n">y1list</span><span class="p">,</span> <span class="n">ax_ymax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;docstring for normed_data&#39;&#39;&#39;</span> 
    <span class="n">unit</span> <span class="o">=</span> <span class="n">ax_ymax</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y1list</span><span class="p">))</span>
    <span class="n">nxlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nylist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y1list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">y1list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">nylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nylist</span><span class="p">)</span><span class="o">*</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nxlist</span><span class="p">,</span> <span class="n">nylist</span>

</div>
<div class="viewcode-block" id="plot_contribution"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_contribution">[文档]</a><span class="k">def</span> <span class="nf">plot_contribution</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;docstring for plot_contribution&#39;&#39;&#39;</span> 
    <span class="n">ctri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">v</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ctri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">ax_normed_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ctri</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

    <span class="n">losex</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">losey</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">winx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">winy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">losex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
            <span class="n">losey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctri</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">winx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">winy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctri</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">losey</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">accumulate</span><span class="p">(</span><span class="n">losey</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">losey</span> <span class="o">=</span> <span class="n">losey</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">winy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">accumulate</span><span class="p">(</span><span class="n">winy</span><span class="p">)]</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">ax_normed_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losey</span><span class="o">+</span><span class="n">winy</span><span class="p">),</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">)</span>
        
</div>
<div class="viewcode-block" id="plot_summary2"><a class="viewcode-back" href="../../../../quantdigger.plugin.mplotwidgets.html#quantdigger.plugin.mplotwidgets.stock_plot.plot_summary2">[文档]</a><span class="k">def</span> <span class="nf">plot_summary2</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">entry_best</span><span class="p">,</span> <span class="n">data_win</span><span class="p">,</span> <span class="n">data_lose</span><span class="p">,</span> <span class="n">exit_profit</span><span class="p">,</span>
                    <span class="n">exit_nbar_best</span><span class="p">,</span> <span class="n">exit_nbar_worst</span><span class="p">,</span> <span class="n">nbar</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; loseed arguments &#39;&#39;&#39;</span>
    <span class="n">cursors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">winrtn</span> <span class="o">=</span> <span class="n">rtn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_win</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">losertn</span> <span class="o">=</span> <span class="n">rtn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_lose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s">u&#39;画图汇总二&#39;</span><span class="p">)</span>
    <span class="n">ax11</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">losertn</span><span class="p">)),</span> <span class="n">losertn</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;yo--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;亏损回撤&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">losertn</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">winrtn</span><span class="p">)),</span> <span class="n">winrtn</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;ro--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;盈利回撤&#39;</span><span class="p">)</span>
    <span class="n">ax11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rtn</span><span class="o">.</span><span class="n">order</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>

    <span class="n">ax11</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cursor</span><span class="p">(</span><span class="n">ax11</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>

    <span class="n">ax11</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">u&#39;回撤&#39;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_big</span><span class="p">)</span>

    <span class="n">ax12</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">binwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rtn</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mi">30</span>
    <span class="c">#rtn.plot(ax=ax12, kind=&#39;kde&#39;, color=&#39;b&#39;, label=&quot;&quot;)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rtn</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rtn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span>
    <span class="n">rst</span> <span class="o">=</span> <span class="n">ax12</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;回撤分布&#39;</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">rst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plot_contribution</span><span class="p">(</span><span class="n">ax12</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="s">&#39;bo--&#39;</span><span class="p">)</span>
    <span class="n">ax12</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cursor</span><span class="p">(</span><span class="n">ax12</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>

    <span class="c">#ax21 = fig.add_subplot(3, 2, 3)</span>
    <span class="c">#ds = entry_best.reindex(data_lose.index)-data_lose[&#39;exit_profit&#39;]</span>
    <span class="c">#ax21.plot(range(len(ds)), ds, &#39;yo--&#39;, label=u&#39;亏损回吐&#39;)</span>
    <span class="c">#dl = (entry_best.reindex(data_win.index)-data_win[&#39;exit_profit&#39;]).tolist()</span>
    <span class="c">#ax21.plot(len(ds)+np.arange(len(dl)), dl, &#39;ro--&#39;, label=u&#39;盈利回吐&#39;)</span>
    <span class="c">#ax21.set_xticklabels([])</span>
    <span class="c">#ax21.set_xlabel(u&#39;回吐&#39;, fontproperties=font_big)</span>
    <span class="c">#ax21.legend(prop=font, loc=&#39;upper left&#39;).get_frame().set_alpha(0.5)</span>
    <span class="c">#cursors.append(Cursor(ax21, useblit=True, color=&#39;red&#39;, linewidth=1, </span>
                                <span class="c">#vertOn = True, horizOn = True))</span>


    <span class="c">#diff = entry_best - exit_profit</span>
    <span class="c">#ax22 = fig.add_subplot(3, 2, 4)</span>
    <span class="c">#binwidth = (diff.max() - diff.min()) / 30</span>
    <span class="c">##diff.plot(ax=ax22, kind=&#39;kde&#39;, color=&#39;b&#39;, label=&quot;&quot;)</span>
    <span class="c">#bins = np.arange(diff.min(), diff.max() + binwidth, binwidth)</span>
    <span class="c">#rst = ax22.hist(diff, bins=bins, color = &#39;y&#39; , normed=False, label=u&#39;回吐分布&#39;)</span>
    <span class="c">#n, bins = rst[0], rst[1]</span>
    <span class="c">#plot_contribution(ax22, bins, diff, &#39;bo--&#39;)</span>
    <span class="c">#ax22.legend(prop=font, loc=&#39;upper left&#39;).get_frame().set_alpha(0.5)</span>
    <span class="c">#cursors.append(Cursor(ax22, useblit=True, color=&#39;red&#39;, linewidth=1, </span>
                                <span class="c">#vertOn = True, horizOn = True))</span>
    <span class="k">if</span> <span class="n">nbar</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ax31</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_nbar_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_lose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="n">data_lose</span><span class="p">[</span><span class="s">&#39;exit_profit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_nbar_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_lose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="n">data_lose</span><span class="p">[</span><span class="s">&#39;exit_profit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">bl</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bl</span><span class="p">)),</span> <span class="n">bl</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_nbar_best</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_win</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="n">data_win</span><span class="p">[</span><span class="s">&#39;exit_profit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
        <span class="n">ww</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_nbar_worst</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">data_win</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="n">data_win</span><span class="p">[</span><span class="s">&#39;exit_profit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">bw</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bw</span><span class="p">)),</span> <span class="n">bw</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ww</span><span class="p">)),</span> <span class="n">ww</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ww</span><span class="p">)),</span> <span class="n">bw</span><span class="p">,</span> <span class="n">ww</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&#39;hello&#39;</span><span class="p">)</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_lose</span><span class="p">[</span><span class="s">&#39;exit_profit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">bl</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">cursors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cursor</span><span class="p">(</span><span class="n">ax31</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                    <span class="n">vertOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">horizOn</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
        <span class="n">ax31</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax31</span><span class="p">],</span> <span class="n">cursors</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python 模块索引"
             >模块</a> |</li>
        <li><a href="../../../../index.html">quantdigger 0.1 文档</a> &raquo;</li>
          <li><a href="../../../index.html" >模块代码</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; 版权所有 2015, QuantFans.
    </div>
  </body>
</html>